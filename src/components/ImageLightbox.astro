---
/**
 * ImageLightbox component
 * Lazy loads GLightbox on first image click
 */
---

<script>
  let lightboxInstance: any = null;

  async function loadAndOpenLightbox(clickedElement: HTMLElement) {
    if (!lightboxInstance) {
      // Lazy load GLightbox and its CSS
      const [{ default: GLightbox }] = await Promise.all([
        import("glightbox"),
        import("glightbox/dist/css/glightbox.min.css"),
      ]);

      lightboxInstance = GLightbox({
        selector: ".ckeditor-content .glightbox",
        touchNavigation: true,
        loop: false,
        closeOnOutsideClick: true,
      });
    }

    // Find the index of the clicked image and open at that position
    const images = document.querySelectorAll(".ckeditor-content .glightbox");
    const index = Array.from(images).indexOf(clickedElement);
    lightboxInstance.openAt(index >= 0 ? index : 0);
  }

  function initLightbox() {
    document.querySelectorAll(".ckeditor-content .glightbox").forEach((img) => {
      img.addEventListener("click", (e) => {
        e.preventDefault();
        loadAndOpenLightbox(img as HTMLElement);
      });
    });
  }

  // Initialize on page load
  initLightbox();

  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", initLightbox);
</script>
